name: CI Testing Pipeline

on:
  workflow_dispatch:
  workflow_call:

jobs:
  run_linter:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ vars.NODE_VERSION }}

      - name: Run linting
        run: pnpm lint

      - name: Run stylelint
        run: pnpm stylelint

  run_integration_tests:
    runs-on: ubuntu-24.04-arm
    services:
      postgres:
        image: postgres:17-alpine3.22
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: tokistack_integration_tests
        ports:
          - "5433:5432"
        options: >-
          --health-cmd pg_isready
          --health-interval 2s
          --health-timeout 5s
          --health-retries 10

    strategy:
      matrix:
        include:
          - module: "@tokistack/db-migrator"
            test_command: pnpm --filter @tokistack/db-migrator test
            requires_migration: false

          - module: "@tokistack/api"
            test_command: pnpm --filter @tokistack/api test
            requires_migration: true

          - module: "@tokistack/authorizer"
            test_command: pnpm --filter @tokistack/authorizer test
            requires_migration: false

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ vars.NODE_VERSION }}

      - name: Build packages
        run: pnpm turbo build

      - name: Apply migrations
        if: ${{ matrix.requires_migration }}
        run: pnpm --filter @tokistack/db-migrator db:migrate
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5433/tokistack_integration_tests
          DEV_OR_INTEGRATION_USE: "true"

      - name: Run tests for ${{ matrix.module }}
        run: ${{ matrix.test_command }}

  run_cdk_tests:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ vars.NODE_VERSION }}

      - name: Run CDK tests
        run: pnpm --filter @tokistack/aws test

  run_web_tests:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ vars.NODE_VERSION }}

      - name: Run web tests
        run: pnpm --filter @tokistack/web test:ci

  ci-success:
    runs-on: ubuntu-24.04-arm
    if: always()
    needs: [run_linter, run_integration_tests, run_cdk_tests, run_web_tests]
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled"
            exit 1
          fi
